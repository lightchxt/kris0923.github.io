<!doctype html><html lang=zh-cn data-theme=light><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.94.2"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="一文了解MySql"><meta itemprop=description content="保持简单的易用性和强大的功能。"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://blog.ibird.site/imgs/hugo_next_avatar.png"><meta itemprop=keywords content="MySql"><meta property="og:type" content="article"><meta property="og:title" content="一文了解MySql"><meta property="og:description" content="保持简单的易用性和强大的功能。"><meta property="og:image" content="/imgs/hugo_next_avatar.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://blog.ibird.site/post/mysql/"><meta property="og:site_name" content="指北针"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="NexT 主题"><meta property="article:published_time" content="2021-09-08 22:36:54 +0800 CST"><meta property="article:modified_time" content="2021-09-08 22:36:54 +0800 CST"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.86a7a7c29f538cdd0ae1d72f069841fdd01254a11c71a1fe2bd0bfd4dcc9a42d.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(t,n,e){if(e===0)return;const s=new Date,o=e*864e5,i={value:n,expiry:s.getTime()+o};localStorage.setItem(t,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==void 0)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"mysql","permalink":"https://blog.ibird.site/post/mysql/","title":"一文了解MySql","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>一文了解MySql - 指北针</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label=切换导航栏 role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>指北针</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>为 Hugo 打造的主题</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-flinks"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-thumbs-up hvr-icon"></i>站点示例</a></li><li class="menu-item menu-item-archives"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>28</span></a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#myslq-逻辑架构>MySlq 逻辑架构</a></li><li><a href=#为什么不要使用长事务>为什么不要使用长事务：</a></li><li><a href=#事务的启动方式>事务的启动方式：</a></li><li><a href=#使用自增id做主键有什么好处>使用自增ID做主键有什么好处：</a></li><li><a href=#全局锁和表锁>全局锁和表锁：</a></li><li><a href=#数据库备份>数据库备份：</a></li><li><a href=#行锁>行锁：</a><ul><li><a href=#死锁和死锁检测>死锁和死锁检测：</a></li><li><a href=#出现死锁时有两种策略>出现死锁时有两种策略：</a><ul><li><a href=#死锁检测要消耗大量的cpu资源所以需要解决热点行更新的性能问题>死锁检测要消耗大量的CPU资源，所以需要解决热点行更新的性能问题：</a></li></ul></li><li><a href=#乐观锁和悲观锁>乐观锁和悲观锁</a></li></ul></li><li><a href=#索引选择优化器>索引选择：（优化器）</a></li><li><a href=#为字符串类型的字段建立索引>为字符串类型的字段建立索引</a><ul><li><a href=#缺点>缺点：</a></li></ul></li><li><a href=#mysql-为什么有时会发生的抖动>MySql 为什么有时会发生的抖动</a></li><li><a href=#order-by-执行过程>Order by 执行过程：</a></li><li><a href=#mysql不使用索引的场景>MySql不使用索引的场景：</a></li><li><a href=#mysql查询慢的原因>MySql查询慢的原因</a></li><li><a href=#什么情况会出现幻读>什么情况会出现幻读：</a><ul><li><a href=#gap-lock>Gap Lock：</a></li></ul></li><li><a href=#mysql加锁规则两个原则两个优化一个bug>MySql加锁规则：（两个原则，两个优化，一个BUG）</a></li><li><a href=#mysql-如何保证数据不丢>MySql 如何保证数据不丢：</a><ul><li><a href=#流程>流程：</a></li></ul></li><li><a href=#性能优化>性能优化：</a></li><li><a href=#主备一致>主备一致：</a><ul><li><a href=#主备延迟的原因>主备延迟的原因：</a></li><li><a href=#可靠性优先的主从切换策略>可靠性优先的主从切换策略：</a></li><li><a href=#并行复制>并行复制：</a></li><li><a href=#分发策略>分发策略：</a></li></ul></li><li><a href=#gtid-主从同步>GTID （主从同步）</a></li><li><a href=#读写分离的弊端>读写分离的弊端</a><ul><li><a href=#主从延迟>主从延迟：</a><ul><li><a href=#等主库位点的方案>等主库位点的方案</a></li><li><a href=#gtid方案>GTID方案</a></li></ul></li></ul></li><li><a href=#mysql健康检查>MySql健康检查</a></li><li><a href=#误删数据找回>误删数据找回</a><ul><li><a href=#误删行-delete>误删行 delete</a></li><li><a href=#误删库表>误删库/表</a></li><li><a href=#预防>预防：</a></li><li><a href=#rm数据>rm数据</a></li></ul></li><li><a href=#kill-query-kill-connection>kill query/ kill connection</a><ul><li><a href=#kill-不能生效的情况>kill 不能生效的情况：</a></li></ul></li><li><a href=#读取数据>读取数据</a></li><li><a href=#join>Join</a></li><li><a href=#muity-range-read-优化>Muity-Range Read 优化：</a></li><li><a href=#临时表的应用>临时表的应用</a><ul><li><a href=#内部临时表>内部临时表</a><ul><li><a href=#使用场景>使用场景：</a></li></ul></li></ul></li><li><a href=#主键自增不连续的原因>主键自增不连续的原因：</a></li><li><a href=#表复制>表复制</a><ul><li><a href=#mysqldump>mysqldump</a></li><li><a href=#导出csv文件>导出csv文件</a></li></ul></li><li><a href=#物理拷贝>物理拷贝</a></li><li><a href=#flush-privileges>Flush Privileges</a></li><li><a href=#分区表>分区表</a></li><li><a href=#自增id>自增ID</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt="NexT 主题" src=/imgs/img-lazy-loading.gif data-src=/imgs/hugo_next_avatar.png><p class=site-author-name itemprop=name>NexT 主题</p><div class=site-description itemprop=description>保持简单的易用性和强大的功能。</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>28</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>11</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>12</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/lightchxt title="Github → https://github.com/lightchxt" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>Github</a></span>
<span class=links-of-social-item><a href=https://www.zhihu.com/people/wo-gang-gang-shuo-liao-shi-yao title="知乎 → https://www.zhihu.com/people/wo-gang-gang-shuo-liao-shi-yao" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>知乎</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=2018-12-17T00:15:23+08:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=28770></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=72></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2023-07-11T23:35:33+08:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-gtranslate class=button title=多语言翻译><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a>
<a href=https://github.com/hugo-next rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script>
<script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://blog.ibird.site/post/mysql/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/hugo_next_avatar.png"><meta itemprop=name content="NexT 主题"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="NexT 主题"><meta itemprop=description content="保持简单的易用性和强大的功能。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="一文了解MySql"><meta itemprop=description content="MySlq 逻辑架构 {{ $image := .Resources.GetMatch &ldquo;mysql.png&rdquo; }} 为什么不要使用长事务： 长事务意味着系统里面存在着很老的事务视图，在事务提交之前这些回滚记录都必须保留，导致占用大量的存"></span><header class=post-header><h1 class=post-title itemprop="name headline">一文了解MySql
<a href=https://github.com/user-name/repo-name/tree/branch-name/subdirectory-name/post/mysql/index.md rel="noopener external nofollow noreferrer" target=_blank class="exturl post-edit-link" title=编辑><i class="fa fa-pen-nib"></i></a></h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text>发表于：</span>
<time title="发表于：2021-09-08 22:36:54 +0800 CST" itemprop="dateCreated datePublished" datetime="2021-09-08 22:36:54 +0800 CST">2021-09-08</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i></span>
<span class=post-meta-item-text>分类于：</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/mysql itemprop=url rel=index><span itemprop=name>MySql</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>字数：</span><span>5988</span></span>
<span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>阅读：&ap;</span>
<span>12分钟</span></span>
<span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="far fa-eye"></i></span>
<span class=post-meta-item-text>浏览：</span>
<span id=busuanzi_value_page_pv class=waline-pageview-count data-path=/post/mysql/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><h2 id=myslq-逻辑架构>MySlq 逻辑架构</h2><p>{{ $image := .Resources.GetMatch &ldquo;mysql.png&rdquo; }}</p><image src=mysql.png width="{{ $image.Width }}" height="{{ $image.Height }}"><h2 id=为什么不要使用长事务>为什么不要使用长事务：</h2><ol><li>长事务意味着系统里面存在着很老的事务视图，在事务提交之前这些回滚记录都必须保留，导致占用大量的存储空间</li><li>占用锁资源，可能拖垮整库</li></ol><h2 id=事务的启动方式>事务的启动方式：</h2><ol><li>显式启动事务语句， begin 或 start transaction。配套的提交语句是 commit，回滚语句是 rollback</li><li>set autocommit=0，这个命令会将这个线程的自动提交关掉。意味着如果只执行一个 select 语句，这个事务就启动了，而且并不会自动提交。这个事务持续存在直到你主动执行 commit 或 rollback 语句，或者断开连接
在set autocommit=0 的情况下，如果是长连接，就有可能导致意外的长事务，所以建议使用set autocommit=1</li></ol><h2 id=使用自增id做主键有什么好处>使用自增ID做主键有什么好处：</h2><ol><li>二级索引叶子节点占用空间小，int占4字节，bigint 占8字节</li><li>自增ID符合B+树索引递增插入的模式，每次插入一条新记录都是追加操作，不会涉及挪动其他数据</li><li>用做KV存储的时候才适合用业务ID做主键</li><li>MySql 5.6 之后支持了索引下推。减少回表次数</li></ol><h2 id=全局锁和表锁>全局锁和表锁：</h2><h2 id=数据库备份>数据库备份：</h2><p>对于支持事务的引擎可以使用mysql-dump &ndash;single-transaction来保证视图的一致性，其他的需要使用FTWRL加全局锁来保证
表锁：</p><ul><li>表锁</li><li>元数据锁</li></ul><p>lock tables &mldr; read/write, unlock tables &mldr; 释放锁
MDL (metadata lock) 不需要显示使用，在访问一个表的时候会自动加上，保证读写的正确性</p><h2 id=行锁>行锁：</h2><h3 id=死锁和死锁检测>死锁和死锁检测：</h3><h3 id=出现死锁时有两种策略>出现死锁时有两种策略：</h3><ol><li>直接进入等待，直到超时，超时时间通过innodb_wait_timeout 来设置</li><li>发起死锁检测，发现死锁后主动回滚死锁链条中某一个事务，使其他事务能够继续执行，通过设置innodb_deadlock_decect</li></ol><h4 id=死锁检测要消耗大量的cpu资源所以需要解决热点行更新的性能问题>死锁检测要消耗大量的CPU资源，所以需要解决热点行更新的性能问题：</h4><ol><li>临时关掉死锁检测（不可取）</li><li>控制并发度，比如控制同一行数据最多只有10个线程在同时更新，做在数据库服务端的中间件</li><li>业务上做优化，将一行数据拆分成多行，但业务代码需要考虑详细，如某行数据为0等</li></ol><h3 id=乐观锁和悲观锁>乐观锁和悲观锁</h3><p>乐观锁与悲观锁是从程序员的角度进行划分：</p><ul><li>乐观锁：认为对同一数据的操作并不总发生，实用时间戳或者版本号机制来保证数据操作的排他性</li><li>悲观锁：通过数据库本身的锁机制来保证数据的排他性</li></ul><h2 id=索引选择优化器>索引选择：（优化器）</h2><ol><li>扫描行数</li><li>是否回表</li><li>是否排序</li><li>是否使用临时表
analyize table t 重新统计索引信息</li></ol><h2 id=为字符串类型的字段建立索引>为字符串类型的字段建立索引</h2><ol><li>使用前缀索引，只使用前n个字符</li><li>倒序存储，正着存前n个字符的区分度比较低，如身份证号</li><li>hash字段，可能有冲突，需要精确判断字段是否相同</li></ol><h3 id=缺点>缺点：</h3><ul><li>前缀索引不能使用覆盖索引</li><li>倒序存储和哈希都不支持范围查询</li></ul><h2 id=mysql-为什么有时会发生的抖动>MySql 为什么有时会发生的抖动</h2><p>当出现以下情况时，系统正在刷脏页：</p><ol><li>redo log满了，正在flush redo log</li><li>内存不足，需要淘汰一些内存页，如果是脏页，要回写磁盘，保证每个数据页只有两种状态：</li></ol><ul><li>在内存里，内存里就是正确的结果</li><li>不在内存中，文件中是正确的结果，这样的话效率最高</li></ul><ol start=3><li>MySql认为系统空闲，刷脏页</li><li>MySql正常关闭</li></ol><blockquote><p>innodb_io_capacity 控制刷脏页的策略</p></blockquote><h2 id=order-by-执行过程>Order by 执行过程：</h2><ol><li>全字段排序（数据单行长度小于max_length_for_sort_data）：从索引中找出满足条件的主键ID，按主键ID取出整行，将查询的字段放入sort_buffer中，然后多sort_buffer中的字段做快速排序（如果数据大于sort_buffer_size，还需要使用外部排序），取前n条记录返回客户端；</li><li>rowid排序：从索引中找出满足条件的主键ID，按主键ID取出整行，将排序字段和ID放入sort_buffer中，对sort_buffer 中的数据进行排序，取前n行，按主键ID从原表中取出查询字段返回给客户端
两种方式相比：全字段排序需要更多的内存，rowid排序需要再次惠表查询数据</li></ol><h2 id=mysql不使用索引的场景>MySql不使用索引的场景：</h2><ol><li>对索引字段做函数操作</li><li>隐式类型转换</li><li>字符编码转换
本质是都是：破坏了索引值的有序性：</li></ol><h2 id=mysql查询慢的原因>MySql查询慢的原因</h2><ol><li>查询长时间不返回：<ul><li>等MDL锁</li><li>等flush</li><li>等行锁</li></ul></li><li>查询慢：<ul><li>没有索引，扫描行数多</li><li>事务内一致性读，多次执行undo log</li></ul></li></ol><h2 id=什么情况会出现幻读>什么情况会出现幻读：</h2><ol><li>在可重复读的隔离级别下，仅“当前读”才会出现幻读</li><li>幻读仅指新插入的行</li></ol><h3 id=gap-lock>Gap Lock：</h3><p>为了解决幻读的问题，但也可能引起死锁（锁住同一个间隙，然后向同一个间隙insert数据）</p><p>在读已提交的隔离级别下，没有间隙锁，但是需要把binlog的格式设置为row（statement格式可能日志顺序错乱）</p><h2 id=mysql加锁规则两个原则两个优化一个bug>MySql加锁规则：（两个原则，两个优化，一个BUG）</h2><p>默认在RR隔离级别下</p><ul><li>原则1:加锁的基本单位是next-key lock，是前开后闭区间</li><li>原则2:查找过程中访问到的对象才会加锁</li><li>优化1:索引上的等值查询，给唯一索引加锁的时候，next-key lock 退化为行锁</li><li>优化2:索引上的等值查询，向右查询且最后一个值不满足等值条件的时候，next-key lock退化为间隙锁</li><li>一个BUG：唯一索引上的范围查询会访问到不满足条件的第一个值为止</li></ul><p>间隙锁和间隙锁之间并不冲突，限制的是不能insert</p><p>gh-ost MySql Online DDL 工具
pt-query-digist</p><h2 id=mysql-如何保证数据不丢>MySql 如何保证数据不丢：</h2><ol><li>Bin log的写入机制：事务执行的过程中写把日志写到binlog_cache,事务提交的时候先把binlog_cache写入到binlog文件中
trx running -> binlog_cache -> trx commit->binlog_file -> fsync disk
sync_binlog 控制什么时候fsync到磁盘</li><li>sync_binlog=0 的时候，表示每次提交事务都只 write，不 fsync；</li><li>sync_binlog=1 的时候，表示每次提交事务都会执行 fsync；</li><li>sync_binlog=N(N>1) 的时候，表示每次提交事务都 write，但累积 N 个事务后才 fsync。</li><li>redo log写入机制：</li></ol><h3 id=流程>流程：</h3><p>redolog_buffer -> write disk -> fsync(真正持久化)</p><p>所以redo log 有三种状态：</p><ul><li>innodb_flush_log_at_trx_commit控制了redolog的写入策略：</li><li>innodb_flush_log_at_trx_commit = 0， 只写到redolog buffer</li><li>innodb_flush_log_at_trx_commit = 1，每次事务提交都持久化到磁盘</li><li>innodb_flush_log_at_trx_commit = 2，每次事务提交都写到文件系统的page cache中</li></ul><h2 id=性能优化>性能优化：</h2><ul><li>组提交 binlog_group_commit_sync_delay（延迟多少微秒后才调用 fsync）， binlog_group_commit_sync_no_delay_count（累积多少次以后才调用 fsync） 减少 binlog 的写盘次数</li><li>将 sync_binlog 设置为大于 1 的值（比较常见是 100~1000）。这样做的风险是，主机掉电时会丢 binlog 日志。</li><li>将 innodb_flush_log_at_trx_commit 设置为 2。这样做的风险是，主机掉电的时候会丢数据。</li></ul><h2 id=主备一致>主备一致：</h2><p>不应该设置binlog_format 为statement，可能会引起主备不一致（加了limit的时候，如果使用的索引不一样，排序可能不同），至少是mixed</p><p>每个库的server id 必须不同，生成的binlog中的server id不同，保证不会循环复制</p><h3 id=主备延迟的原因>主备延迟的原因：</h3><ul><li>备库的机器性能比主库差</li><li>备库查询压力大</li><li>主库执行大事务：</li><li>大表的DDL</li></ul><h3 id=可靠性优先的主从切换策略>可靠性优先的主从切换策略：</h3><ul><li>判断从库的seconds_behind_master小于某个值，比如5s，否则一直重复这一步</li><li>主库改readonly=true</li><li>判断从库的seconds_behind_master，直到等于0</li><li>从库修改readonly=false（可读写状态）</li><li>业务请求切换到从库（新主库）</li></ul><h3 id=并行复制>并行复制：</h3><p>coordinator 在分发Relay log的时候，需要满足以下这两个基本要求：</p><ul><li>不能造成覆盖更新，这就要求更新同一行的两个事务必须分发到同一个worker中</li><li>同一个事务不能被拆开，必须放到同一个worker中</li></ul><h3 id=分发策略>分发策略：</h3><ul><li>按表分发，适用于多表的负载均衡，对于热点数据表，可能退化成为单线程复制</li><li>按行分发，要求binlog的格式必须是row, 并行度高，但是操作大事务的时候，耗费内存和CPU</li></ul><p>Maria 模拟主库的并行，将相同commitID的事务分发给不同的worker，但是也容易被大事务拖后腿</p><h2 id=gtid-主从同步>GTID （主从同步）</h2><p>全称是 Global Transaction Identifier，也就是全局事务 ID，是一个事务在提交的时候生成的，是这个事务的唯一标识。它由两部分组成，格式是：
GTID=server_uuid:gno</p><p>server_uuid 是一个实例第一次启动时自动生成的，是一个全局唯一的值</p><p>gno 是一个整数，初始值是 1，每次提交事务的时候分配给这个事务，并加 1</p><h2 id=读写分离的弊端>读写分离的弊端</h2><p>两种架构：客户端直连和带Proxy</p><h3 id=主从延迟>主从延迟：</h3><ul><li>强制走主库</li><li>sleep（不靠谱）</li><li>判断主备无延迟：<ul><li><p>a. show salve status 判断second_behind_master是否等于0</p></li><li><p>b. Master_Log_File和Relay_master_Log_Pos、Read_Master_Log_Pos 和Exec_Master_Log_Pos 这两组值完全相同（读到主库的最新位点和备库执行的最新位点）</p></li><li><p>c. 对比GTID集合，Auto_Position=1, Retrieved_Gtid_set 和 Executed_Gtid_Set两个集合相同</p></li></ul></li></ul><p>b，c比a要精确很多，second_behind_master单位是秒</p><p>但是b, c 也是完全准确的，可能有一部分binlog正在从主库发送到从库</p><p>配合上semi-sync（半同步复制）+位点判断可以解决e的问题，但仅限于一主一从，多从的情况下，一个从库发送ack主库就提交事务了</p><p>业务高峰期，主库位点更新很快，所以位点判断一直不相等，可能出现从库迟迟无法响应的情况</p><h4 id=等主库位点的方案>等主库位点的方案</h4><p>主库事务提交后立即执行 show master status，得到当前的file 和position，从库执行select master_pos_wait(File, Position,1),如果大于0，则已包含刚才提交的事务</p><h4 id=gtid方案>GTID方案</h4><p>select wait_for_executed_gtid_set(gtid_set, 1) = 0 表示从库中已经包含传入的gtid_set</p><p>5.7 之后的版本会把gtid返回给客户端</p><h2 id=mysql健康检查>MySql健康检查</h2><p>SHOW VARIABLES LIKE &lsquo;innodb_thread_concurrency&rsquo;; 并发查询数</p><p>等行锁和间隙锁的线程是不算在并发查询数里面的
select 1；
update 系统表数据
内部统计，判断单次I/O 是否大于某个时间</p><h2 id=误删数据找回>误删数据找回</h2><h3 id=误删行-delete>误删行 delete</h3><ul><li>flashback工具，需要保证binlig_format=row和binlog_row_image=FULL</li><li>提前预防：设置sql_safe_updates=on, delete 和update的语句中必须有where条件且包含索引字段</li></ul><h3 id=误删库表>误删库/表</h3><ul><li>全量备份+增量日志 mysqlbinlog</li><li>搭建延迟复制备库，指定一个备库和主库有N秒的延迟，减少需要恢复的数据</li></ul><h3 id=预防>预防：</h3><ul><li>帐号分离，不给Drop、truncate的权限</li><li>日常使用只读帐号</li><li>删表之前，先做更名操作，观察一段时间再删</li></ul><h3 id=rm数据>rm数据</h3><ul><li>高可用（HA）集群只要不是把整个集群删除，HA会自动选出一个新主库</li></ul><h2 id=kill-query-kill-connection>kill query/ kill connection</h2><ol><li>MySql kill 和 linux的kill命令类似，并不是直接终止，而是给进程发送一个终止的信号；</li><li>把被kill的session的状态改成 THD::KILL_QUERY</li><li>给被kill的session</li></ol><h3 id=kill-不能生效的情况>kill 不能生效的情况：</h3><ol><li>线程没有执行到判断线程状态的逻辑（一直在循环判断是否可以执行）</li><li>终止逻辑耗时较长</li><li>超大事务执行被kill，回滚操作耗时较长</li><li>大查询回滚，生成了比较大的临时文件，如果文件系统压力大，则删除临时文件可能需要等待I/O资源</li><li>DDL命令执行到最后阶段，如果被kill，也需要删除过程中的临时文件</li></ol><h2 id=读取数据>读取数据</h2><p>客户端使用 &ndash;quick 参数会使用mysq_use_result方法
mysql_use_result: 读一行处理一行，如果处理的很慢，客户端过很久才去读下一行，会出现sending to client
mysql_store_result: 将查询的结果保存到本地内存
查询结果是分段发送给客户端的，所以不会打爆内存
Innodb Buffer Pull的LRU 算法是用链表实现的，并且分成young区和old区（5：3）；每次淘汰都是在old去，在old区存在超过1s的数据才能进入young区，保证了在全表扫描的时候，正常业务的查询命中率不会降低</p><h2 id=join>Join</h2><ul><li>如果可以使用被驱动表的索引，join 语句是有其优势的；</li><li>不能使用被驱动表的索引，只能使用 Block Nested-Loop Join 算法，这样的语句就尽量不要使用；</li><li>join_buffer_size 设定了join buffer的大小，越大被驱动表扫描的次数越少，扫描次数 N + k*M</li><li>在使用 join 的时候，应该让小表做驱动表</li><li>通过where条件过滤之后的数据量小的为小表</li></ul><h2 id=muity-range-read-优化>Muity-Range Read 优化：</h2><p>思路：因为大多数数据都是按照主键id自增的顺序插入到得到的，所以按照主键id递增的顺序查询是比较接近顺序读，能够提升读性能
实现：将根据索引定位到的记录放到read_rnd_buffer中，将read_rnd_buffer 中的id递增排序，用排序后的数组到主键索引中查找记录
BKA (Batched Key Access)，对 BNL算法的优化</p><ul><li>在被驱动表上加索引</li><li>创建临时表
不支持hash join</li></ul><h2 id=临时表的应用>临时表的应用</h2><ul><li>分库分表系统的跨库查询</li><li>在使用分区key的查询中可以直接定位到数据放在了哪一个表</li><li>未使用到分区key的查询，只能到所有分区中区查找数据，然后统一操作</li><li>在proxy中实现，需要的工作量大，对中间层的开发能力比较高，对proxy的压力比较大</li><li>把各个分库拿到的数据汇总到一个Mysql实例的一个表中，然后在这个汇总的实力上操作（临时表）</li></ul><h3 id=内部临时表>内部临时表</h3><h4 id=使用场景>使用场景：</h4><ul><li>UNION：需要对结果去重，需要使用临时表，Union ALL 就不需要</li><li>Group By：无序的数据需要对结果统计计数</li><li>如果执行过程可以一边读数据，一边直接得到结果，就不需要额外的内存</li><li>join_buffer 是无序数组，sort_buffer是有序数组，临时表是二维表结构</li><li>如果需要二维表的特性，就会考虑使用临时表（union 唯一索引约束，group by 需要额外的字段计数）</li><li>SQL_BIG_RESULT 告诉Mysq 直接使用排序算法得到group by的结果</li></ul><blockquote><p>除了内存临时表，普通的内存表不建议使用，一是不支持行锁，性能可能并没有预想的好，二是在集群架构上数据持久化可能会有问题
主键自增</p></blockquote><p>innoDB引擎的索引值存在内存里，MyISAM存储在数据文件中，8.0版本之后记录到了redolog中，保证重启也不会丢失</p><h2 id=主键自增不连续的原因>主键自增不连续的原因：</h2><ul><li>插入数据失败</li><li>事务回滚</li><li>批量插入，每次申请的自增id的数量都是上一次的两倍，最后未用完的就浪费了</li></ul><h2 id=表复制>表复制</h2><h3 id=mysqldump>mysqldump</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>mysqldump -h$host -P$port -u$user --add-locks=0 --no-create-info --single-transaction  --set-gtid-purged=OFF db1 t --where=&#34;a&gt;900&#34; --result-file=/client_tmp/t.sql
</span></span></code></pre></div><h3 id=导出csv文件>导出csv文件</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>select * from db1.t where a&gt;900 into outfile &#39;/server_tmp/t.csv&#39;;
</span></span></code></pre></div><p>生成的文件在服务器上，不在客户端机器上
受 secure_file_priv 的限制
目标文件不存在</p><h2 id=物理拷贝>物理拷贝</h2><p>5.6之前是不允许的，5.6之后引入了可传输表空间</p><h2 id=flush-privileges>Flush Privileges</h2><ol><li>grant/revoke语句会同时修改数据表和内存，正常情况下是没有必要跟flush privileges 的；</li><li>不规范的操作，直接使用DML操作系统权限表才需要跟flush privileges；</li></ol><h2 id=分区表>分区表</h2><ol><li>对于引擎层来说，分区表是多个表；对于Server层来说分区表是一个表</li><li>不建议使用分区表的原因：
MySql在第一次打开分区表的时候需要访问所有的分区
在Server层认为是同一张表，因此公用同一个MDl锁，执行DDL时，影响更大</li></ol><h2 id=自增id>自增ID</h2><ol><li>如果没有指定自增ID，MySql会创建一个不可见的长度为6个字节的row_id; 当row_id达到最大值(2^48 -1)后，再申请row_id就是0，并且会覆盖原来的数据</li><li>redolog 和 binlog中的Xid（Server层维护）是事务中执行的第一个Sql的query_id, global_query_id 是一个内存变量，重启后会清零，但同时也会生成新的binlog文件，所以同一个binlog文件中的xid是唯一的</li><li>Innodb trx_id 事务ID是引擎层维护的，最大值2^48-1, 只读事务不分配trx_id，理论上，只要MySql运行的足够久，trx_id重新从0开始分配就会出现幻读</li></ol></div><footer class=post-footer><div class=post-tags><a href=/tags/mysql>MySql</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right><ul><li class=post-copyright-title><strong>文章标题：</strong>
一文了解MySql</li><li class=post-copyright-author><strong>本文作者：</strong>
NexT 主题</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://blog.ibird.site/post/mysql/ title=一文了解MySql>https://blog.ibird.site/post/mysql/</a></li><li class=post-copyright-license><strong>版权声明：</strong>
本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=/images/wechat_channel.jpg><span class=icon><i class="fab fa-weixin"></i></span>
<span class=label>WeChat</span></a></div><div class=social-item><a target=_blank class=social-link href=/atom.xml><span class=icon><i class="fa fa-rss"></i></span>
<span class=label>RSS</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/redis/ rel=next title=Redis数据过期策略><i class="fa fa-chevron-left"></i> Redis数据过期策略</a></div><div class="post-nav-prev post-nav-item"><a href=/post/%E8%AE%A1%E7%AE%97%E5%B9%BF%E5%91%8A/ rel=prev title=计算广告>计算广告
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2023</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>NexT 主题</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.94.2 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.4.1 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=vendors-list><a target=_blank href=https://vercel.com title=Vercel><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/vercel.svg alt=Vercel></a>
<a target=_blank href=https://upyun.com title=又拍云><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/upyun.png alt=又拍云></a>
<a target=_blank href=https://webify.cloudbase.net title=Webify>Webify</a>
<span>提供CDN/云资源支持</span></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"busuanzi":{"pageview":true},"copybtn":true,"darkmode":false,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"https://blog.ibird.site","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"statis":{"enable":true,"plugin":"busuanzi"},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.4.1","waline":{"cfg":{"comment":true,"emoji":false,"imguploader":false,"pageview":true,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.c9d1c5371f2aeab3aa44b03b4fbf4a67428818a5a25781b738681c2e39ff4f30.js defer></script></body></html>